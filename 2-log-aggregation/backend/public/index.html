<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Real-Time Log Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            body {
                font-family: monospace;
                background-color: #0d0d0d;
                color: #e0e0e0;
                margin: 0;
                padding: 20px;
            }

            h2 {
                color: #00ffff;
                text-align: center;
                margin-bottom: 10px;
            }

            #charts {
                display: flex;
                justify-content: center;
                margin-bottom: 20px;
            }

            #logChart {
                background: #111;
                padding: 10px;
                border-radius: 10px;
                width: 80%;
                max-height: 250px;
            }

            #filter {
                margin-bottom: 12px;
                display: flex;
                justify-content: center;
                gap: 10px;
            }

            select {
                padding: 4px 8px;
                background: #222;
                color: #eee;
                border: 1px solid #333;
                border-radius: 4px;
            }

            #logs {
                max-height: 55vh;
                overflow-y: auto;
                padding: 10px;
                border: 1px solid #333;
                border-radius: 10px;
                background: #111;
            }

            .log {
                border-bottom: 1px solid #222;
                margin: 6px 0;
                padding: 6px 8px;
                border-radius: 5px;
            }

            .INFO {
                color: #00ff00;
            }
            .WARN {
                color: #ffcc00;
            }
            .ERROR {
                color: #ff3333;
                font-weight: bold;
            }

            .timestamp {
                color: #999;
                font-size: 0.9em;
            }
            .service {
                color: #66ccff;
            }
            .level {
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <h2>ðŸ“Š Real-Time Log Dashboard</h2>

        <div id="charts">
            <canvas id="logChart"></canvas>
        </div>

        <div id="filter">
            <label for="levelFilter">Filter by level:</label>
            <select id="levelFilter">
                <option value="ALL">ALL</option>
                <option value="INFO">INFO</option>
                <option value="WARN">WARN</option>
                <option value="ERROR">ERROR</option>
            </select>
        </div>

        <div id="logs"></div>

        <script>
            const container = document.getElementById("logs");
            const levelFilter = document.getElementById("levelFilter");

            // ==================== Chart Setup ====================
            const ctx = document.getElementById("logChart").getContext("2d");
            const chartData = {
                labels: [],
                datasets: [
                    {
                        label: "INFO",
                        borderColor: "#00ff00",
                        data: [],
                        fill: false,
                    },
                    {
                        label: "WARN",
                        borderColor: "#ffcc00",
                        data: [],
                        fill: false,
                    },
                    {
                        label: "ERROR",
                        borderColor: "#ff3333",
                        data: [],
                        fill: false,
                    },
                ],
            };

            const logChart = new Chart(ctx, {
                type: "line",
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: "#ccc" } },
                    },
                    scales: {
                        x: {
                            ticks: { color: "#aaa" },
                            grid: { color: "#333" },
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: "#aaa" },
                            grid: { color: "#333" },
                        },
                    },
                },
            });

            // Maintain counts over time
            const counts = { INFO: 0, WARN: 0, ERROR: 0 };

            function updateChart(level) {
                const now = new Date().toLocaleTimeString();
                chartData.labels.push(now);

                counts[level]++;
                chartData.datasets[0].data.push(counts.INFO);
                chartData.datasets[1].data.push(counts.WARN);
                chartData.datasets[2].data.push(counts.ERROR);

                // Keep only last 20 points
                if (chartData.labels.length > 20) {
                    chartData.labels.shift();
                    chartData.datasets.forEach((d) => d.data.shift());
                }

                logChart.update();
            }

            // ==================== Log Rendering ====================
            function addLog(log) {
                const div = document.createElement("div");
                div.className = `log ${log.level}`;
                div.innerHTML = `
          <span class="timestamp">[${log.timestamp}]</span>
          <span class="service">[${log.service}]</span>
          <span class="level ${log.level}">[${log.level}]</span>
          <span class="message">${log.message}</span>
        `;
                container.prepend(div);
                applyFilter();
                updateChart(log.level);
            }

            function applyFilter() {
                const selected = levelFilter.value;
                document.querySelectorAll(".log").forEach((log) => {
                    if (
                        selected === "ALL" ||
                        log.classList.contains(selected)
                    ) {
                        log.style.display = "block";
                    } else {
                        log.style.display = "none";
                    }
                });
            }

            levelFilter.addEventListener("change", applyFilter);

            // ==================== Data Sources ====================
            fetch("/logs")
                .then((res) => res.json())
                .then((data) => {
                    data.reverse().forEach(addLog);
                });

            const ws = new WebSocket("ws://localhost:4000");
            ws.onmessage = (event) => {
                const log = JSON.parse(event.data);
                addLog(log);
            };
        </script>
    </body>
</html>
